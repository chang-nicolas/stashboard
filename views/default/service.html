{% extends "base.html" %}

{% block js_end %}
    <script type="text/javascript">
      $(document).ready(function(){
        
        var createRow = function(data) {
          var d = new Date(data.timestamp);
          
          var time = $.datepicker.formatDate("MM d, ", d);
          var hour;
          var period; 
          
          if (d.getHours() < 12) {
              if (d.getHours() === 0) {
                  hour = 12;
              } else {
                  hour = d.getHours();
              }
              period = "AM";
          } else if (d.getHours() == 12){
              hour = d.getHours();
              period = "PM";
          } else {
              hour = d.getHours() - 12;
              period = "PM";
          }
          
          if (d.getMinutes() < 10) {
            time += hour + ":0" + d.getMinutes() + period; 
          } else {
            time += hour + ":" + d.getMinutes() + period;
          }

          var tr = $('<tr />');
          
          $('<td />', {text: time}).appendTo(tr);

	  if (data.informational) {
	      image = "/images/status/information.png";
	  } else {
              image = data.status.image;
          }
          
          $('<td />', {"class": "status highlight"}).append(
            $('<img />', {
              src: image, 
              alt: data.status.name
            })
          ).appendTo(tr);
          
          $('<td />', {text: data.message}).appendTo(tr);

          {% if user_is_admin %}
          
            $('<td />', {"class": "delete"}).append(
              $('<a />', {href: data.url}).append(
                $('<img />', {
                  src: "/images/status/minus-circle.png",
                  alt: "Delete"
                  })
              )
            ).appendTo(tr);
            
          {% endif %}
          
          return tr;
        };
        
        
        $.ajax({
          type: "GET",
          url: "/api/v1/services/{{ service }}",
          dataType: "json",
          success: function(service){
            
            $("h2 span").text(service.name);
	    $("#serviceDescription").text(service.description);
            
            {% if user_is_admin %}
            
            {% endif %}
            
            var populatStatuses = function(current) {
              
              $.ajax({
                type: "GET",
                url: "/api/v1/statuses",
                dataType: "json",
                context: $("#statusValue"),
                success: function(data){

                  var statuses = data.statuses;

                  for (var i=0; i < statuses.length; i++) {
                    
                    var selected = false;
                    if (current === statuses[i].name){
                      selected = true;
                    }
                    $("<option />", {
                      "name": "severity",
                      val: statuses[i].id,
                      text: statuses[i].name,
                      selected: selected
                    }).appendTo($(this));
                  }

                },
                error: function(){

                }
              });
            
            };

	    eventsURL = "/api/v1/services/" + service.id + "/events";
	    
	    {% if start_date %}

	    var start = rfc1123(new Date("{{ start_date }}"));
	    var end = rfc1123(new Date("{{ end_date }}"));

	    eventsURL += "?start=" + start;
	    eventsURL += "&end=" + end;

	    {% endif %}

            $.ajax({ 
              type: "GET",
              url: eventsURL,
              dataType: "json",
              context: $(".event-log").children('tbody'), 
              success: function(data){

                var events = data.events;
                var length = events.length;
                
                if (length > 0) {
                  populatStatuses(events[0].status.name);
                  for (var i=0; i < length; i++) {
                    var tr = createRow(events[i]);
                    $(this).append(tr);  
                  }
                } else {
                  populatStatuses();
                }
                
                

              },
              error: function(){
                populatStatuses();
              }
            });
            
            $("#delete-service").click(function(event){
              $("#delete-service-modal").dialog({
                    resizable: false,
                    modal: true,
                    buttons: {
                      'Delete Service': function(){
                        $.ajax({ 
                          type: "DELETE",
                          url: "/api/v1/services/" + service.id,
                          dataType: 'json', 
                          success: function(data){
                            location.replace("/");  
                          }
                        });
                      },
                      'Cancel': function(){
                        $(this).dialog('close');
                      }
                    }
              });
            });

            $("#update-status").click(function(event){
              event.preventDefault();
              $("#add-event-modal").dialog({
		    height: 290,
		    width: 460,
                    resizable: false,
                    modal: true,
                    buttons: {
                      'Update Status': function(){
	                $.ajax({ 
			type: "POST",
			url: "/api/v1/services/" + service.id + "/events",
			data: {
			  status: $("#statusValue").val(),
			  message: $("#eventMessage").val()
			},
			dataType: "json",
			context:$("#add-event-modal"), 
			success: function(data){
			    this.dialog('close');
			    var tr = createRow(data);
			    $(".event-log").children('tbody').prepend(tr);
			    },
			error: function(){
			    this.dialog('close');
			    stashboard.error("Could not create event due to missing form data");
			}
		        });
                      },
                      'Cancel': function(){
                        $(this).dialog('close');
                      }
                    }
		});
            });

            $("#add-note").click(function(event){
              event.preventDefault();
              $("#add-note-modal").dialog({
		    height: 250,
		    width: 460,
                    resizable: false,
                    modal: true,
                    buttons: {
                      'Add Note': function(){
	                $.ajax({ 
			type: "POST",
			url: "/api/v1/services/" + service.id + "/events",
			data: {
			  message: $("#noteMessage").val(),
			  informational: "true"
			},
			dataType: "json",
			context:$("#add-note-modal"), 
			success: function(data){
			    this.dialog('close');
			    var tr = createRow(data);
			    $(".event-log").children('tbody').prepend(tr);
			    },
			error: function(){
			    this.dialog('close');
			    stashboard.error("Could not create note due to missing message");
			}
		        });
                      },
                      'Cancel': function(){
                        $(this).dialog('close');
                      }
                    }
		});
            });

        $("#service-name").val(service.name);
        $("#service-description").val(service.description);


	$("#edit-service").click(function(e){
	    e.preventDefault();
            $("#edit-service-modal").dialog({
              height: 310,
              width: 460,
              resizable: false,
              modal: true,
              buttons: {
                'Edit Service': function(){
                  $.ajax({ 
                    type: "POST",
                    url: "/api/v1/services/" + service.id,
                    data: { 
                      name: $("#service-name").val(), 
                      description: $("#service-description").val()
                      },
                    dataType: 'json', 
                    success: function(data){ 
                      $("#edit-service-modal").dialog('close');
			$("#serviceDescription").text(data.description);
			$("h2 span").text(data.name);
			$("#service-name").val(data.name);
			$("#service-description").val(data.description);
                      },
                    error: function(evt){ 
                      $("#edit-service-modal").dialog('close');
		        stashboard.error("Could not create edit service information");
                      }
                    });
                    
                },
                'Cancel': function(){
                  $(this).dialog('close');
                }
              }
            });
        });

            
          },
          error: function(){
            
          }
        });
        
        $("td.delete a").live('click', function(event){
          event.preventDefault();
          $.ajax({ 
            type: "DELETE",
            data: {},
            url: $(this).attr("href"), 
            context: $(this).parent().parent(), 
            success: function(){
                  $(this).fadeOut('fast', function(){
                    $(this).remove();
                  });
                },
            error: function(){
                  stashboard.error("Could not deleted event. Please try again");
                }
            });
        });
      });
    </script>
{% endblock %}

{% block content %}
        
      <div id="webservices" class="frame">
        
        {% if user_is_admin %}
          <a class="button" id="update-status">
	    Update Status
          </a>
          <a class="button" id="add-note">
	    Add Note
          </a>


        {% endif %}
        
        <h2><span></span></h2>

	<p id="serviceDescription"></p>

        {% if start_date %}        
          <h3 class="date-range">
            {{ start_date|date:"n/j/Y"  }}
          </h3>  
        {% endif %}      

        <table class="event-log" cellpadding="10">
          <thead>
            <tr>
              <th class="time-header">Time</th>
              <th class="status-header">Status</th>
              <th>Message</th>
              {% if user_is_admin %}
                <th class="delete-header">Delete</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="events-tbody">
          </tbody>
        </table>

        {% if user_is_admin %}
          <a class="button" id="delete-service">
            Delete Service
          </a>
          <a class="button" id="edit-service">
            Edit Service
          </a>
        {% endif %}


      </div>
      
      {% if user_is_admin %}
      
      <div class="dialog" id="delete-service-modal" title="Delete Service">
        <p>Are you sure you want to delete this service?</p>
      </div>

      <div class="dialog" id="add-note-modal" title="Add Note">
	<label id="messageLabel" for="message">Message:</label>
	<textarea id="noteMessage" class="update-message" name="message"></textarea>
      </div>

      <div class="dialog" id="add-event-modal" title="Update Status">
	<label id="statusLabel" for="status">Status:</label>
	<select id="statusValue" class="update-status" name="severity"></select>
	<label id="messageLabel" for="message">Message:</label>
	<textarea id="eventMessage" class="update-message" name="message"></textarea>
      </div>

      <div class="dialog" id="edit-service-modal" title="Edit Service">
        <label  for="service-name">Name</label>
        <input type="text" id="service-name" name="service-name">
        <label for="service-description">Description</label>
        <textarea
          id="service-description" name="service-description"></textarea>
      </div>
      
      {% endif %}

{% endblock %}

