{% extends "base.html" %}

{% block js %}
    <script type="text/javascript">
      $(document).ready(function(){

        $(".button").button();
        
        
        $("#delete-service").click(function(event){
          $("#delete-service-modal").dialog({
                resizable: false,
                modal: true,
                buttons: {
                  'Delete Service': function(){
                    $.ajax({ 
                      type: "DELETE",
                      url: "/api/services/{{ service.slug }}/",
                      dataType: 'json', 
                      success: function(data){
                        location.replace("/");  
                      }
                    });
                  },
                  'Cancel': function(){
                    $(this).dialog('close');
                  }
                }
          });
        });
        
        $("#add-event").click(function(event){
          event.preventDefault();
          
          $.ajax({ 
            type: "POST",
            url: "/api/services/{{ service.slug }}/events/",
            data: {
              status: $("#statusValue").val(),
              message: $("#messageValue").val(),
            },
            dataType: "json",
            context: $(".event-log").children('tbody'), 
            success: function(data){
                var d = new Date(data.timestamp);
                
                var time = $.datepicker.formatDate("MM d, ", d);
                var hour;
                var period; 
                
                if (d.getHours() < 12) {
                    if (d.getHours() == 0) {
                        hour = 12;
                    } else {
                        hour = d.getHours();
                    }
                    period = "AM";
                } else if (d.getHours() == 12){
                    hour = d.getHours();
                    period = "PM";
                } else {
                    hour = d.getHours() - 12;
                    period = "PM";
                }
                
                time += hour + ":" + d.getMinutes() + period;
                
                var row = '<tr><td>' + time + '</td>';
                row += '<td class="status highlight"><img src="' + data.status.image + '" alt=""/></td>';
                row += '<td>' + data.message + '</td>';
                row += '<td class="delete"><a class="delete-event"  href="/api/services/{{ service.slug }}/events/' +                           data.sid + '/"> <img src="/images/status/minus-circle.png" alt="Delete"/></a></td>';
                row += '</tr>';
                $(this).prepend(row);
              },
            error: function(){
              },
            });
        });
        
        
        $(".delete-event").live('click', function(event){
          event.preventDefault();
          $.ajax({ 
            type: "DELETE",
            data: {},
            url: $(this).attr("href"), 
            context: $(this).parent().parent(), 
            success: function(){
                  $(this).fadeOut('fast', function(){
                    $(this).remove();
                  });
                },
            error: function(){
                  alert("CRAP");
                },
            });
        });
      });
    </script>
{% endblock %}

{% block content %}
        
      <div id="services">
        
        {% if user_is_admin %}
          <a class="button" id="delete-service">
            Delete Service
          </a>
        {% endif %}
        
        <h2>
          {{ service.name }}
        </h2>
        
        <h3 class="date-range">
          {% if start_date %}
            {{ start_date|date:"n/j/Y"  }}
          {% endif %}

          {% if end_date %}
             - {{ end_date|date:"n/j/Y"  }}
          {% endif %}
        </h3>
        
        {% if user_is_admin %}
        <div id="submit">
            <label id="statusLabel" for="status">Status:</label>
            <select id="statusValue" class="update-status" name="severity">
              {% for status in statuses %}
                <option   name="severity" value="{{ status.name }}">{{ status.name|capfirst }}</option>
              {% endfor %}
            </select>
            <label id="messageLabel" for="message">Message:</label>
            <textarea id="messageValue" class="update-message" name="message"></textarea>

            <a id="add-event" class="button update-submit" href="#">
              Add New Event
            </a>
        </div>
        {% endif %}
        
        <table class="event-log" cellpadding="10">
          <thead>
            <tr>
              <th class="time-header">Time</th>
              <th class="status-header">Status</th>
              <th>Message</th>
              {% if user_is_admin %}
                <th class="delete-header">Delete</th>
              {% endif %}
            </tr>
          </thead>
          {% for event in events %}
            <tr>
                <td>{{ event.start|date:"N j, fA"  }}</td>
                <td class="status highlight">
            <img src="/images/status/{{ event.status.image}}"
                    alt="{{ event.name }}"/>
                </td>
                <td>{{ event.message }}</td>
                
                {% if user_is_admin %}
                  <td class="delete"><a class="delete-event" 
                    href="/api/services/{{ service.slug }}/events/{{ event.sid }}/">
                    <img src="/images/status/minus-circle.png"
                            alt="Delete"/>
                  </a></td>
                {% endif %}
            </tr>
          {% endfor %}
        </table>
      </div>
      
      {% if user_is_admin %}
      
      <div id="delete-service-modal" title="Delete New Service">
        <p>Are you sure you want to delete the {{ service.name }} service?</p>
      </div>

      {% endif %}

{% endblock %}

