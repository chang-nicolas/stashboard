{% extends "base.html" %}

{% block js %}
    <script type="text/javascript">
      $(document).ready(function(){
        $("#statusBox").click(function(){
          if($(this).is(":checked")){
            $("#submit .status").removeAttr('disabled');
          } else {
            $("#submit .status").attr('disabled', 'disabled');
          }
        });
        
        $("#messageBox").click(function(){
          if($(this).is(":checked")){
            $("#submit .message").removeAttr('disabled');
          } else {
            $("#submit .message").attr('disabled', 'disabled');
          }
        });
        
        $("#add-service").click(function(){
          $("#add-service-modal").dialog('open');
        });
        
        $("#add-status").click(function(){
          $("#add-status-modal").dialog('open');
        })
        
        $("#add-service-modal").dialog({
              height: 300,
              width: 450,
              resizable: false,
              modal: true,
              autoOpen: false,
              buttons: {
                'Create Service': function(){
                  $.ajax({ 
                    type: "POST",
                    url: "/api/services",
                    data: { 
                      name: $("#service-name").val(), 
                      description: $("#service-description").val()
                      },
                    dataType: 'json', 
                    context: $("#service-list"), 
                    success: function(data){ 
                      $("#add-service-modal").dialog('close');
                        
                      //This is kinda ugly
                      var tr = '<tr><td><a href="services/' + data.id;
                      tr += '">' + data.name + '</a></td>';
                      tr += '<td class="status highlight"><img src="/images/status/question-white.png" alt=""></td>';
                      
                      for (var i=0; i < 5; i++) {
                        tr += '<td class="status"><img src="/images/status/question-white.png" alt=""></td>';
                      };
                      
                      tr += '</tr>';
                      
                      $("#service-list").fadeIn('fast', function(){    
                        $("#service-list").children('tbody').append(tr);
                      });
                      
                      },
                    error: function(){ 
                      $("#add-service-modal").dialog('close');
                      },
                    });
                    
                },
                'Cancel': function(){
                  $(this).dialog('close');
                }
              }
        });
        
        $("#add-status-modal").dialog({
              height: 300,
              width: 450,
              resizable: false,
              modal: true,
              autoOpen: false,
              buttons: {
                'Create Status': function(){
                  $.ajax({ 
                    type: "POST",
                    url: "/api/statuses/",
                    data: { 
                      name: $("#status-name").val(), 
                      description: $("#status-description").val(),
                      image: $("#status-image").val(),
                      severity: $("#status-severity").val()
                    },
                    dataType: 'json', 
                    context: $(".legend").children('tbody'), 
                    success: function(data){ 
                      $("#add-status-modal").dialog('close');
                      var tr = "<tr><td class=\"icon\">";
                      tr += '<img src="' + data.image + '" ';
                      tr += 'alt="' + data.name + '"/></td>';
                      tr += '<td>' + data.description + '</td>';
                      tr += '<td>' + data.severity + '</td>';
                      tr += '</tr>';
                      $(this).append(tr);
                    },
                    error: function(){ 
                      $("#add-status-modal").dialog('close');
                    },
                  });
                    
                },
                'Cancel': function(){
                  $(this).dialog('close');
                }
              }
        });
        
        $(".delete-status").live('click', function(event){
          event.preventDefault(); 
        });
        
        $(".delete-status").live('click', function(event){
          event.preventDefault();
          $.ajax({ 
            type: "DELETE",
            data: {},
            url: $(this).attr("href"), 
            context: $(this).parent().parent(), 
            success: function(){
                  $(this).fadeOut('fast', function(){
                    $(this).remove();
                  });
                },
            error: function(){
                  alert("CRAP");
                },
            });
        });
        
        
      });
    </script>
{% endblock %}

{% block content %}

      <div id="services" class="frame">
        
          <table id="service-list">
            <thead>
              <tr>
                <th>Service</th>
                <th class="today">Today</th>
              
                {% for day in past %}
                  <th class="date">{{ day|date:"N j" }}</th>
                {% endfor %}

            </thead>
            {% for service in services %}
              <tr>
                  <td>
                    <a href="services/{{service.slug}}/">{{ service.name }}
                  </td>
                
                  <td class="status highlight">
                    <a href="services/{{ service.slug }}">
                    <img src="/images/status/{{ service.current_event.status.image}}"
                      alt="{{ service.current_event.name }}"/>
                    </a>
                  </td>
                
                  {% for date in service.past_five_days %}
                    <td class="status">
                      {% if date %}
                        <a href="services/{{ service.slug }}/{{ date.year}}/{{ date.month }}/{{ date.day }}">
                          <img src="/images/status/{{ info_status.image}}"
                                      alt="{{ info_status.name }}"/>
                          </a>
                      {% else %}
                        <img src="/images/status/{{ default_status.image}}"
                                      alt="{{ default_status.name }}"/>
                      {% endif %}
                    </td>
                  {% endfor %}
              </tr>
            {% empty %}
              <tr>
                <td colspan="7">
                  No service information available 
                </td>
              </tr>
            {% endfor %}
          </table>
        
        {% if user_is_admin %}
          <a id="add-service" class="button" href="#">Add New Service</a>
        {% endif %}
        
        {% include "_legend.html" %}
        
      </div>
      
      {% if user_is_admin %}
      
      <div class="dialog" id="add-service-modal" title="Add New Service">
        <label  for="service-name">Name</label>
        <input type="text" id="service-name"name="service-name">
        <label for="service-description">Description</label>
        <textarea
          id="service-description" name="service-description"></textarea>
      </div>
      
      {% endif %}
      
      
{% endblock %}

