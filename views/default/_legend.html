<div class="legend">
  <h4> Legend </h4>
  <table>
    {% if user_is_admin %}
    <thead>
      <tr>
        <th></th>
        <th>Description</th>
        <th>Level</th>
	<th>Edit</th>
	<th>Delete</th>
      </tr>
    </thead>
    {% endif %}
    
    <tbody id="legend-body">
    </tbody>
  </table>
  
  {% if user_is_admin %}
    <a id="add-status" class="button" href="#">Add New Status</a>
    
    <div id="add-status-modal" class="dialog" title="Add New Status">
      <label class="side-label" for="status-name">Name</label>
      <input type="text" id="status-name"name="status-name">
      
      <label class="side-label" for="status-level">Level</label>
      <select id="statusLevel" class="status-level" name="level">
      </select>
      
      <label for="status-image">Image</label>
      {% for image_row in common_statuses %}
        <div>
        {% for image in image_row %}
        
        <input type="radio" name="status-image" value="{{ image }}">
        <img src="/static/images/status/{{ image }}.png" />
        {% endfor %}
        </div>
        
      {% endfor %}

      <label for="status-description">Description</label>
      <textarea
        id="status-description" name="status-description"></textarea>
    </div>

    <div class="dialog" id="delete-status-modal" title="Delete Status">
      <p>Are you sure you want to delete this status? ALL EVENTS with this status will also be deleted</p>
    </div>

  {% endif %}
  
  <script type="text/javascript">
  
  var createStatusRow = function(data){
    var tr = $("<tr />");
    
    $("<td />", {"class": "icon"}).append(
      $("<img />", {
        src: data.image,
        alt: data.name
      })
    ).appendTo(tr);
    
    $("<td />", {"class": "description", text: data.description}).appendTo(tr);
    
    {% if user_is_admin %}
    
    var edit = $("<a />", {text: "Edit", href: data.url});

    $("<td />", {"class": "level", text: data.level}).appendTo(tr);
    $("<td />", {html: edit}).appendTo(tr);
    $("<td />", {html: 
      $("<a />", {text: "Delete", href: data.url, "class": "delete-status"})
    }).appendTo(tr);

    edit.click(function(e){

      e.preventDefault();
      var a = $(e.target);
      var tr = a.parent().parent();
      var img = tr.children(".icon").children("img");
      //This is somewhat ugly
      var value = img.attr("src").split("/").pop().slice(0, -4);

      $("#status-name").val(img.attr("alt"));
      $("#status-description").val(tr.children(".description").text());
      $("#statusLevel").val(tr.children(".level").text());
      $("input[name=status-image]:checked").attr("checked", false);
      $("input[value=" + value + "]").attr("checked", true);

      $("#add-status-modal").dialog({
          height: 515,
          width: 460,
          resizable: false,
          autoOpen: true,
          modal: true,
          buttons: {
            'Save': function(){
              $.ajax({ 
                type: "POST",
                url: a.attr("href"),
                data: { 
                  name: $("#status-name").val(), 
                  description: $("#status-description").val(),
                  image: $("input[name=status-image]:checked").val(),
                  level: $("#statusLevel").val()
                },
                dataType: 'json', 
                context: tr,
                success: function(data){ 
                  $("#add-status-modal").dialog('close');
                  this.children(".description").text(data.description);
                  this.children(".level").text(data.level);
                  this.children(".icon").children("img").attr("alt", data.name);
                  this.children(".icon").children("img").attr("src", data.image);
                },
                error: function(){ 
                  $("#add-status-modal").dialog('close');
		  stashboard.error("Could not save status");
                },
              });
                
            },
            'Cancel': function(){
              $(this).dialog('close');
            }
          }
    });
    });			      


    {% endif %}
    
    $("#legend-body").append(tr);
  }
  
  $(document).ready(function(){

    $("#add-status").click(function(){
      $("#status-name").val("");
      $("#status-description").val("");
      $("#statusLevel").val("");
      $("#add-status-modal").dialog('open');
      $("input[name=status-image]").attr("checked", false);
    });

    
    $.ajax({ 
      type: "GET",
      url: "/api/v1/statuses",
      dataType: 'json', 
      success: function(data){ 
        
          if (data){
            var statuses = data.statuses;
        
            for (var i=0; i < statuses.length; i++) {
              createStatusRow(statuses[i]);
            }
        
          }
        
        },
      error: function(){ 
        
        },
      });
      
      $.ajax({
        type: "GET",
        url: "/api/v1/levels",
        dataType: "json",
        context: $("#statusLevel"),
        success: function(data){
          
          if (data){

            var levels = data.levels;

            for (var i=0; i < levels.length; i++) {
              $("<option />", {
                "name": "level",
                val: levels[i],
                text: levels[i]
              }).appendTo($(this));
            };
          
          }

        },
        error: function(){

        }
      });
    
    $("#add-status-modal").dialog({
          height: 515,
          width: 460,
          resizable: false,
          modal: true,
          autoOpen: false,
          buttons: {
            'Create Status': function(){
              $.ajax({ 
                type: "POST",
                url: "/api/v1/statuses",
                data: { 
                  name: $("#status-name").val(), 
                  description: $("#status-description").val(),
                  image: $("input[name=status-image]:checked").val(),
                  level: $("#statusLevel").val()
                },
                dataType: 'json', 
                context: $(".legend").children('tbody'), 
                success: function(data){ 
                  $("#add-status-modal").dialog('close');
                  createStatusRow(data);
                },
                error: function(){ 
                  $("#add-status-modal").dialog('close');
		  stashboard.error("Could not create new status due to missing information");
                },
              });
                
            },
            'Cancel': function(){
              $(this).dialog('close');
            }
          }
    });

    
    $(".delete-status").live('click', function(e){
      e.preventDefault();			      
      var a = $(e.target); 			     
      $("#delete-status-modal").dialog({
        resizable: false,
        modal: true,
        buttons: {
        'Delete Status': function(){
          $.ajax({ 
            type: "DELETE",
            url: a.attr("href"),
            dataType: 'json',
            context: $("#delete-status-modal"),
            success: function(data){
              a.parent().parent().remove();
              this.dialog('close');
            },
            error: function(){
             this.dialog('close');			     
	     stashboard.error("Unable to delete status");
            },			      
           });
          },
        'Cancel': function(){
          $(this).dialog('close');
        }
      }
     });

    });
    
  });
  </script>
</div>
